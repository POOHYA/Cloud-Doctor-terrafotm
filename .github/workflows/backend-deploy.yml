name: Backend Deploy

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main

# 1ï¸âƒ£ OIDC í† í° ì‚¬ìš© ê¶Œí•œ ì„¤ì •
permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    # 2ï¸âƒ£ í™˜ê²½ë³€ìˆ˜ ì„¤ì • (Secretsì—ì„œ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜´)
    env:
      PGSQL_URL: ${{ secrets.PGSQL_URL }}
      PGSQL_USERNAME: ${{ secrets.PGSQL_USERNAME }}
      PGSQL_PASSWORD: ${{ secrets.PGSQL_PASSWORD }}
      REDIS_HOST: ${{ secrets.REDIS_HOST }}
      REDIS_PORT: ${{ secrets.REDIS_PORT }}
      REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
      ACCESS_TOKEN_EXPIRATION: ${{ secrets.ACCESS_TOKEN_EXPIRATION }}
      REFRESH_TOKEN_EXPIRATION: ${{ secrets.REFRESH_TOKEN_EXPIRATION }}
      COOKIE_SECURE: true
      INFRAAUDIT_API_URL: ${{ secrets.INFRAAUDIT_API_URL }}

    steps:
      # 3ï¸âƒ£ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v3

      # 4ï¸âƒ£ AWS OIDC ì¸ì¦ (Access Key ì—†ì´ Role Assume)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-northeast-2

      # 5ï¸âƒ£ JAR ë¹Œë“œ
      - name: Build JAR
        working-directory: backend/CloudDoctorWeb
        run: ./gradlew clean build -x test

      # 6ï¸âƒ£ Docker ì´ë¯¸ì§€ ë¹Œë“œ
      - name: Build Docker image
        working-directory: backend/CloudDoctorWeb
        run: docker build -t cloud-doctor-backend -f Dockerfile .

      # 7ï¸âƒ£ Docker ì´ë¯¸ì§€ TAR ì €ì¥
      - name: Save Docker image to tar
        run: |
          docker save cloud-doctor-backend -o cloud-doctor-backend.tar
          chmod 644 cloud-doctor-backend.tar

      # 8ï¸âƒ£ Bastion ì„œë²„ë¡œ ì´ë¯¸ì§€ ì—…ë¡œë“œ
      - name: Copy Docker image to Bastion
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.BASTION_PUBLIC_IP }}
          username: ubuntu
          key: ${{ secrets.BASTION_SSH_KEY }}
          source: "cloud-doctor-backend.tar"
          target: "/home/ubuntu/"

      # 9ï¸âƒ£ Bastionì—ì„œ 2ëŒ€ì˜ Private EC2ë¡œ ìˆœì°¨ ë°°í¬
      - name: Deploy on Multiple Private EC2 via Bastion
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.BASTION_PUBLIC_IP }}
          username: ubuntu
          key: ${{ secrets.BASTION_SSH_KEY }}
          script: |
            # ALB ë’¤ì— ìˆëŠ” ì„œë²„ë“¤ì˜ Private IP ë¦¬ìŠ¤íŠ¸ ì •ì˜
            # GitHub Secretsì— BE_SERVER_1_IP, BE_SERVER_2_IPë¥¼ ê°ê° ë“±ë¡í•˜ì„¸ìš”.
            SERVER_IPS=("${{ secrets.BE_SERVER_1_IP }}" "${{ secrets.BE_SERVER_2_IP }}")
            
            for IP in "${SERVER_IPS[@]}"; do
              echo "------------------------------------------------"
              echo "ğŸš€ íƒ€ê²Ÿ ì„œë²„ ë°°í¬ ì‹œì‘: $IP"
              echo "------------------------------------------------"

              # 1. Bastionì—ì„œ í•´ë‹¹ Private EC2ë¡œ ì´ë¯¸ì§€ íŒŒì¼ ì „ì†¡
              scp -i /home/ubuntu/private-cloud-doctor.pem -o StrictHostKeyChecking=no /home/ubuntu/cloud-doctor-backend.tar ubuntu@$IP:/home/ubuntu/

              # 2. í•´ë‹¹ Private EC2ì— ì›ê²© ì ‘ì†í•˜ì—¬ ì»¨í…Œì´ë„ˆ ê°±ì‹ 
              ssh -i /home/ubuntu/private-cloud-doctor.pem -o StrictHostKeyChecking=no ubuntu@$IP << 'EOF'
                # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì´ë¯¸ì§€ ë¡œë“œ
                sudo docker load -i /home/ubuntu/cloud-doctor-backend.tar
                sudo docker stop cloud-doctor-backend || true
                sudo docker rm cloud-doctor-backend || true
                
                # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ë³´ì•ˆ ì²˜ë¦¬ëœ í™˜ê²½ë³€ìˆ˜ ì£¼ì…)
                sudo docker run -d -p 9090:9090 \
                  -e PGSQL_URL="${{ secrets.PGSQL_URL }}" \
                  -e PGSQL_USERNAME="${{ secrets.PGSQL_USERNAME }}" \
                  -e PGSQL_PASSWORD="${{ secrets.PGSQL_PASSWORD }}" \
                  -e REDIS_HOST="${{ secrets.REDIS_HOST }}" \
                  -e REDIS_PORT="${{ secrets.REDIS_PORT }}" \
                  -e REDIS_PASSWORD="${{ secrets.REDIS_PASSWORD }}" \
                  -e ACCESS_TOKEN_EXPIRATION="${{ secrets.ACCESS_TOKEN_EXPIRATION }}" \
                  -e REFRESH_TOKEN_EXPIRATION="${{ secrets.REFRESH_TOKEN_EXPIRATION }}" \
                  -e COOKIE_SECURE=true \
                  -e INFRAAUDIT_API_URL="${{ secrets.INFRAAUDIT_API_URL }}" \
                  --restart unless-stopped \
                  --name cloud-doctor-backend \
                  cloud-doctor-backend
                
                # ë°°í¬ í›„ ì”ì—¬ tar íŒŒì¼ ì‚­ì œ
                rm -f /home/ubuntu/cloud-doctor-backend.tar
            EOF
              echo "âœ… ì„œë²„ ë°°í¬ ì™„ë£Œ: $IP"
              # ALB í—¬ìŠ¤ì²´í¬ ë° ì•ˆì •í™”ë¥¼ ìœ„í•´ 5ì´ˆ ëŒ€ê¸° í›„ ë‹¤ìŒ ì„œë²„ ì§„í–‰
              sleep 5
            done
