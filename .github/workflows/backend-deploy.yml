name: Backend Deploy

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main

# 1️⃣ OIDC 권한 설정 추가
permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    # 환경변수들
    env:
      PGSQL_URL: ${{ secrets.PGSQL_URL }}
      PGSQL_USERNAME: ${{ secrets.PGSQL_USERNAME }}
      PGSQL_PASSWORD: ${{ secrets.PGSQL_PASSWORD }}
      REDIS_HOST: ${{ secrets.REDIS_HOST }}
      REDIS_PORT: ${{ secrets.REDIS_PORT }}
      REDIS_PASSWORD: ""
      ACCESS_TOKEN_EXPIRATION: ${{ secrets.ACCESS_TOKEN_EXPIRATION }}
      REFRESH_TOKEN_EXPIRATION: ${{ secrets.REFRESH_TOKEN_EXPIRATION }}
      COOKIE_SECURE: true
      INFRAAUDIT_API_URL: ${{ secrets.INFRAAUDIT_API_URL }}
      BASTION_PUBLIC_IP: ${{ secrets.BASTION_PUBLIC_IP }}
      PRIVATE_IP: ${{ secrets.PRIVATE_IP }}
      
    steps:
      # 2️⃣ 코드 체크아웃
      - name: Checkout repository
        uses: actions/checkout@v3

      # 3️⃣ AWS OIDC 인증 (추가됨)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-northeast-2

      # 4️⃣ JAR 빌드
      - name: Build JAR
        working-directory: backend/CloudDoctorWeb
        run: ./gradlew clean build -x test

      # 5️⃣ Docker 이미지 빌드
      - name: Build Docker image
        working-directory: backend/CloudDoctorWeb
        run: docker build -t cloud-doctor-backend -f Dockerfile .

      # 6️⃣ Docker 이미지 TAR 저장
      - name: Save Docker image to tar
        run: |
          docker save cloud-doctor-backend -o cloud-doctor-backend.tar
          chmod 644 cloud-doctor-backend.tar

      # 7️⃣ Bastion 서버로 이미지 업로드
      - name: Copy Docker image to Bastion
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.BASTION_PUBLIC_IP }}
          username: ubuntu
          key: ${{ secrets.BASTION_SSH_KEY }}
          source: "cloud-doctor-backend.tar"
          target: "/home/ubuntu/"

      # 8️⃣ Bastion에서 Private EC2로 전송 및 배포
      - name: Deploy on Private EC2 via Bastion
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.BASTION_PUBLIC_IP }}
          username: ubuntu
          key: ${{ secrets.BASTION_SSH_KEY }}
          script: |
            # Private EC2로 전송
            scp -i /home/ubuntu/private-cloud-doctor.pem -o StrictHostKeyChecking=no /home/ubuntu/cloud-doctor-backend.tar ubuntu@${{ secrets.PRIVATE_IP }}:/home/ubuntu/

            # Private EC2에서 배포 (EOF에 따옴표를 붙여 변수 치환 방지)
            ssh -i /home/ubuntu/private-cloud-doctor.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.PRIVATE_IP }} << 'EOF'
              sudo docker load -i /home/ubuntu/cloud-doctor-backend.tar
              sudo docker stop cloud-doctor-backend || true
              sudo docker rm cloud-doctor-backend || true
              
              sudo docker run -d -p 9090:9090 \
                -e PGSQL_URL="${{ secrets.PGSQL_URL }}" \
                -e PGSQL_USERNAME="${{ secrets.PGSQL_USERNAME }}" \
                -e PGSQL_PASSWORD="${{ secrets.PGSQL_PASSWORD }}" \
                -e REDIS_HOST="${{ secrets.REDIS_HOST }}" \
                -e REDIS_PORT="${{ secrets.REDIS_PORT }}" \
                -e REDIS_PASSWORD="" \
                -e ACCESS_TOKEN_EXPIRATION="${{ secrets.ACCESS_TOKEN_EXPIRATION }}" \
                -e REFRESH_TOKEN_EXPIRATION="${{ secrets.REFRESH_TOKEN_EXPIRATION }}" \
                -e COOKIE_SECURE=true \
                -e INFRAAUDIT_API_URL="${{ secrets.INFRAAUDIT_API_URL }}" \
                --restart unless-stopped \
                --name cloud-doctor-backend \
                cloud-doctor-backend
            EOF
