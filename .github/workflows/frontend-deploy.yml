name: Frontend Deploy to Private Subnet

on:
  # 8:40 ì›Œí¬í”Œë¡œ
  schedule:
    - cron: "40 23 * * *"
  workflow_dispatch:
  pull_request:
    branches:
      - main
    paths:
      - 'frontend/**'

# 1ï¸âƒ£ OIDC ê¶Œí•œ ì„¤ì •
permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 2ï¸âƒ£ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v3

      # 3ï¸âƒ£ AWS OIDC ì¸ì¦
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-northeast-2

      # 4ï¸âƒ£ Node.js í™˜ê²½ ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # 5ï¸âƒ£ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ë° ë¹Œë“œ
      - name: Install dependencies and build
        working-directory: frontend/cloud-doctor
        env:
          REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}
          REACT_APP_AUDIT_API_URL: ${{ secrets.REACT_APP_AUDIT_API_URL }}
        run: |
          npm ci
          CI=false npm run build

      # 6ï¸âƒ£ ë¹Œë“œ íŒŒì¼ ì••ì¶• (./build ì•ˆì˜ ë‚´ìš©ë§Œ ì••ì¶•)
      - name: Create build archive
        run: |
          cd frontend/cloud-doctor/build
          tar -czf ../../../build.tar.gz .

      # 7ï¸âƒ£ Bastion ì„œë²„ë¡œ ë¹Œë“œ íŒŒì¼ ì—…ë¡œë“œ
      - name: Copy build files to Bastion
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.BASTION_PUBLIC_IP }}
          username: ubuntu
          key: ${{ secrets.BASTION_SSH_KEY }}
          source: "build.tar.gz"
          target: "/home/ubuntu/"

      # 8ï¸âƒ£ Bastionì—ì„œ ì‹¤ì‹œê°„ ASG ì¸ìŠ¤í„´ìŠ¤ IP ì¡°íšŒ ë° ìˆœì°¨ ë°°í¬
      - name: Deploy to Dynamic ASG Instances via Bastion
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.BASTION_PUBLIC_IP }}
          username: ubuntu
          key: ${{ secrets.BASTION_SSH_KEY }}
          script: |
            # ASG_NAMEì€ GitHub Secretsì— ë“±ë¡í•œ í”„ë¡ íŠ¸ì—”ë“œ Auto Scaling Group ì´ë¦„ì…ë‹ˆë‹¤.
            ASG_NAME="${{ secrets.FE_ASG_NAME }}"
            
            echo "ğŸ” ASG [$ASG_NAME]ì—ì„œ 'InService' ìƒíƒœì¸ ì¸ìŠ¤í„´ìŠ¤ IPë¥¼ ì°¾ëŠ” ì¤‘..."
            
            # 1. ASGì— ì†í•œ ì¸ìŠ¤í„´ìŠ¤ ID ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
            INSTANCE_IDS=$(aws autoscaling describe-auto-scaling-groups \
              --auto-scaling-group-names "$ASG_NAME" \
              --region ap-northeast-2 \
              --query 'AutoScalingGroups[0].Instances[?LifecycleState==`InService`].InstanceId' \
              --output text)
            
            if [ -z "$INSTANCE_IDS" ] || [ "$INSTANCE_IDS" == "None" ]; then
              echo "âŒ ë°°í¬í•  ìˆ˜ ìˆëŠ” ì¸ì„œë¹„ì¦ˆ ìƒíƒœì˜ ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤."
              exit 1
            fi

            # 2. ì¸ìŠ¤í„´ìŠ¤ IDë“¤ì„ ì´ìš©í•´ ê°ê°ì˜ Private IP ì¡°íšŒ
            SERVER_IPS=$(aws ec2 describe-instances \
              --instance-ids $INSTANCE_IDS \
              --region ap-northeast-2 \
              --query 'Reservations[*].Instances[*].PrivateIpAddress' \
              --output text)

            echo "ğŸ“ ì°¾ì•„ë‚¸ ë°°í¬ ëŒ€ìƒ IP: $SERVER_IPS"

            # 3. ì¡°íšŒëœ IPë“¤ì„ ìˆœíšŒí•˜ë©° ë°°í¬ ì§„í–‰
            for IP in $SERVER_IPS; do
              echo "------------------------------------------------"
              echo "ğŸš€ íƒ€ê²Ÿ ì„œë²„ ë°°í¬ ì‹œì‘: $IP"
              echo "------------------------------------------------"

              # Bastionì—ì„œ í•´ë‹¹ Private EC2ë¡œ íŒŒì¼ ë³µì‚¬
              scp -i /home/ubuntu/private-cloud-doctor.pem -o StrictHostKeyChecking=no /home/ubuntu/build.tar.gz ubuntu@$IP:/home/ubuntu/

              # Private EC2 ë‚´ë¶€ ì ‘ì† í›„ ë°°í¬ ë¡œì§ ì‹¤í–‰
              ssh -i /home/ubuntu/private-cloud-doctor.pem -o StrictHostKeyChecking=no ubuntu@$IP << 'EOF'
                # ì„ì‹œ ë””ë ‰í† ë¦¬ ìƒì„± ë° ì••ì¶• í•´ì œ
                mkdir -p ~/temp_build
                tar -xzf ~/build.tar.gz -C ~/temp_build/
                
                # ê¸°ì¡´ íŒŒì¼ êµì²´ ë° ê¶Œí•œ ì„¤ì •
                sudo rm -rf /var/www/html/*
                sudo cp -r ~/temp_build/* /var/www/html/
                sudo chown -R www-data:www-data /var/www/html
                sudo chmod -R 755 /var/www/html
                
                # ì„œë¹„ìŠ¤ ë°˜ì˜
                sudo systemctl reload nginx
                
                # ì •ë¦¬
                rm -f ~/build.tar.gz
                rm -rf ~/temp_build
            EOF
              echo "âœ… ì„œë²„ ë°°í¬ ì„±ê³µ: $IP"
              sleep 5
            done
