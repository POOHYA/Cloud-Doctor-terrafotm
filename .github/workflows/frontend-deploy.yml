name: Frontend Deploy to Private Subnet

on:
  # 8:40 ì›Œí¬í”Œë¡œ
  schedule:
    - cron: "40 23 * * *"
  workflow_dispatch:
  pull_request:
    branches:
      - main
    paths:
      - "frontend/**"

# 1ï¸âƒ£ OIDC ê¶Œí•œ ì„¤ì •
permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 2ï¸âƒ£ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v3

      # 3ï¸âƒ£ AWS OIDC ì¸ì¦
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-northeast-2

      # 4ï¸âƒ£ Node.js í™˜ê²½ ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      # 5ï¸âƒ£ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ë° ë¹Œë“œ
      - name: Install dependencies and build
        working-directory: frontend/cloud-doctor
        env:
          REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}
          REACT_APP_AUDIT_API_URL: ${{ secrets.REACT_APP_AUDIT_API_URL }}
        run: |
          npm ci
          CI=false npm run build

      # 6ï¸âƒ£ ë¹Œë“œ íŒŒì¼ ì••ì¶• (./build ì•ˆì˜ ë‚´ìš©ë§Œ ì••ì¶•)
      - name: Create build archive
        run: |
          cd frontend/cloud-doctor/build
          tar -czf ../../../build.tar.gz .

      # 7ï¸âƒ£ Bastion ì„œë²„ë¡œ ë¹Œë“œ íŒŒì¼ ë° Private Key ì—…ë¡œë“œ
      - name: Copy build files to Bastion
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.BASTION_PUBLIC_IP }}
          username: ec2-user
          key: ${{ secrets.BASTION_SSH_KEY }}
          source: "build.tar.gz"
          target: "/home/ec2-user/"

      - name: Copy Private Key to Bastion
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.BASTION_PUBLIC_IP }}
          username: ec2-user
          key: ${{ secrets.BASTION_SSH_KEY }}
          source: "infra/terraform/clouddoctor-key.pem"
          target: "/home/ec2-user/private-cloud-doctor.pem"
          strip_components: 2

      # 8ï¸âƒ£ ASG ìŠ¤ì¼€ì¼ì—… ë° ì¸ìŠ¤í„´ìŠ¤ ì¤€ë¹„ ëŒ€ê¸°
      - name: Scale up ASG and wait for instances
        run: |
          ASG_NAME="${{ secrets.FE_ASG_NAME }}"

          echo "ğŸ”„ ASG ìŠ¤ì¼€ì¼ì—… ì‹œì‘..."
          aws autoscaling set-desired-capacity \
            --auto-scaling-group-name "$ASG_NAME" \
            --desired-capacity 2 \
            --region ap-northeast-2

          echo "â³ ì¸ìŠ¤í„´ìŠ¤ê°€ InService ìƒíƒœê°€ ë  ë•Œê¹Œì§€ ëŒ€ê¸° ì¤‘..."
          for i in {1..20}; do
            INSTANCE_COUNT=$(aws autoscaling describe-auto-scaling-groups \
              --auto-scaling-group-names "$ASG_NAME" \
              --region ap-northeast-2 \
              --query 'AutoScalingGroups[0].Instances[?LifecycleState==`InService`].InstanceId' \
              --output text | wc -w)
            
            if [ "$INSTANCE_COUNT" -ge 1 ]; then
              echo "âœ… $INSTANCE_COUNT ê°œì˜ ì¸ìŠ¤í„´ìŠ¤ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤."
              break
            fi
            
            echo "ëŒ€ê¸° ì¤‘... ($i/20)"
            sleep 30
          done

      # 9ï¸âƒ£ ASG ì¸ìŠ¤í„´ìŠ¤ IP ì¡°íšŒ
      - name: Get ASG Instance IPs
        id: get_ips
        run: |
          ASG_NAME="${{ secrets.FE_ASG_NAME }}"
          
          INSTANCE_IDS=$(aws autoscaling describe-auto-scaling-groups \
            --auto-scaling-group-names "$ASG_NAME" \
            --region ap-northeast-2 \
            --query 'AutoScalingGroups[0].Instances[?LifecycleState==`InService`].InstanceId' \
            --output text)
          
          SERVER_IPS=$(aws ec2 describe-instances \
            --instance-ids $INSTANCE_IDS \
            --region ap-northeast-2 \
            --query 'Reservations[*].Instances[*].PrivateIpAddress' \
            --output text)
          
          echo "SERVER_IPS=$SERVER_IPS" >> $GITHUB_OUTPUT
          echo "ğŸ“ ë°°í¬ ëŒ€ìƒ IP: $SERVER_IPS"

      # ğŸ”Ÿ Bastionì„ í†µí•œ ë°°í¬
      - name: Deploy via Bastion
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.BASTION_PUBLIC_IP }}
          username: ec2-user
          key: ${{ secrets.BASTION_SSH_KEY }}
          script: |
            chmod 400 /home/ec2-user/private-cloud-doctor.pem
            
            SERVER_IPS="${{ steps.get_ips.outputs.SERVER_IPS }}"
            echo "ğŸ“ ë°°í¬ ëŒ€ìƒ IP: $SERVER_IPS"
            
            for IP in $SERVER_IPS; do
              echo "------------------------------------------------"
              echo "ğŸš€ ë°°í¬ ì‹œì‘: $IP"
              echo "------------------------------------------------"
              
              scp -i /home/ec2-user/private-cloud-doctor.pem -o StrictHostKeyChecking=no /home/ec2-user/build.tar.gz ec2-user@$IP:/home/ec2-user/
              
              ssh -i /home/ec2-user/private-cloud-doctor.pem -o StrictHostKeyChecking=no ec2-user@$IP << 'EOF'
            mkdir -p ~/temp_build
            tar -xzf ~/build.tar.gz -C ~/temp_build/
            sudo rm -rf /var/www/html/*
            sudo cp -r ~/temp_build/* /var/www/html/
            sudo chown -R nginx:nginx /var/www/html
            sudo chmod -R 755 /var/www/html
            sudo systemctl reload nginx
            rm -f ~/build.tar.gz
            rm -rf ~/temp_build
            EOF
              echo "âœ… ë°°í¬ ì„±ê³µ: $IP"
              sleep 5
            done

      # â­ AMI ìƒì„±
      - name: Create AMI from deployed instance
        id: create_ami
        run: |
          ASG_NAME="${{ secrets.FE_ASG_NAME }}"
          
          INSTANCE_ID=$(aws autoscaling describe-auto-scaling-groups \
            --auto-scaling-group-names "$ASG_NAME" \
            --region ap-northeast-2 \
            --query 'AutoScalingGroups[0].Instances[0].InstanceId' \
            --output text)
          
          echo "ğŸ“¸ AMI ìƒì„± ì¤‘..."
          AMI_ID=$(aws ec2 create-image \
            --instance-id $INSTANCE_ID \
            --name "clouddoctor-frontend-$(date +%Y%m%d-%H%M%S)" \
            --description "Frontend deployment $(date)" \
            --region ap-northeast-2 \
            --output text)
          
          echo "AMI_ID=$AMI_ID" >> $GITHUB_OUTPUT
          echo "âœ… AMI ìƒì„± ì™„ë£Œ: $AMI_ID"
          
          echo "â³ AMI ì‚¬ìš© ê°€ëŠ¥í•  ë•Œê¹Œì§€ ëŒ€ê¸°..."
          aws ec2 wait image-available --image-ids $AMI_ID --region ap-northeast-2
          echo "âœ… AMI ì‚¬ìš© ê°€ëŠ¥"

      # ğŸ—‘ï¸ ì˜¤ë˜ëœ AMI ì‚­ì œ (3ê°œë§Œ ìœ ì§€)
      - name: Delete old AMIs
        run: |
          echo "ğŸ—‘ï¸ ì˜¤ë˜ëœ AMI ì‚­ì œ ì¤‘..."
          OLD_AMIS=$(aws ec2 describe-images \
            --owners self \
            --filters "Name=name,Values=clouddoctor-frontend-*" \
            --query 'sort_by(Images, &CreationDate)[:-3].ImageId' \
            --region ap-northeast-2 \
            --output text)
          
          for AMI in $OLD_AMIS; do
            echo "AMI ì‚­ì œ: $AMI"
            SNAPSHOTS=$(aws ec2 describe-images --image-ids $AMI --region ap-northeast-2 --query 'Images[0].BlockDeviceMappings[*].Ebs.SnapshotId' --output text)
            aws ec2 deregister-image --image-id $AMI --region ap-northeast-2
            for SNAP in $SNAPSHOTS; do
              aws ec2 delete-snapshot --snapshot-id $SNAP --region ap-northeast-2 || true
            done
          done
          echo "âœ… ì˜¤ë˜ëœ AMI ì‚­ì œ ì™„ë£Œ"

      # ğŸ”„ Launch Template ì—…ë°ì´íŠ¸
      - name: Update Launch Template
        run: |
          LAUNCH_TEMPLATE_NAME="clouddoctor-frontend"
          AMI_ID="${{ steps.create_ami.outputs.AMI_ID }}"
          
          echo "ğŸ”„ Launch Template ì—…ë°ì´íŠ¸ ì¤‘..."
          aws ec2 create-launch-template-version \
            --launch-template-name $LAUNCH_TEMPLATE_NAME \
            --source-version '$Latest' \
            --launch-template-data "{\"ImageId\":\"$AMI_ID\"}" \
            --region ap-northeast-2
          
          aws ec2 modify-launch-template \
            --launch-template-name $LAUNCH_TEMPLATE_NAME \
            --default-version '$Latest' \
            --region ap-northeast-2
          
          echo "âœ… Launch Template ì—…ë°ì´íŠ¸ ì™„ë£Œ"

      # ğŸ” ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ êµì²´ (ì¸ìŠ¤í„´ìŠ¤ ë¦¬í”„ë ˆì‹œ)
      - name: Refresh ASG instances
        run: |
          ASG_NAME="${{ secrets.FE_ASG_NAME }}"
          
          echo "ğŸ” ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ êµì²´ ì‹œì‘..."
          aws autoscaling start-instance-refresh \
            --auto-scaling-group-name "$ASG_NAME" \
            --preferences '{"MinHealthyPercentage":50,"InstanceWarmup":60}' \
            --region ap-northeast-2
          
          echo "â³ ì¸ìŠ¤í„´ìŠ¤ ë¦¬í”„ë ˆì‹œ ì™„ë£Œ ëŒ€ê¸°..."
          aws autoscaling wait instance-refresh-complete \
            --auto-scaling-group-name "$ASG_NAME" \
            --region ap-northeast-2 || true
          
          echo "âœ… ì¸ìŠ¤í„´ìŠ¤ êµì²´ ì™„ë£Œ"

      # ğŸ”Ÿ ë°°í¬ ì™„ë£Œ í›„ ASG ìŠ¤ì¼€ì¼ë‹¤ìš´
      - name: Scale down ASG after deployment
        if: always()
        run: |
          ASG_NAME="${{ secrets.FE_ASG_NAME }}"
          echo "ğŸ”½ ë°°í¬ ì™„ë£Œ - ASG ìŠ¤ì¼€ì¼ë‹¤ìš´ ì‹œì‘..."
          aws autoscaling set-desired-capacity \
            --auto-scaling-group-name "$ASG_NAME" \
            --desired-capacity 0 \
            --region ap-northeast-2
          echo "âœ… ASG ìŠ¤ì¼€ì¼ë‹¤ìš´ ì™„ë£Œ"
