name: Python Backend Deploy

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
    paths:
      - 'infraaudit/**'

# 1️⃣ OIDC 토큰 사용을 위한 권한 설정 (추가 필수)
permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 2️⃣ 코드 체크아웃
      - name: Checkout repository
        uses: actions/checkout@v3

      # 3️⃣ AWS OIDC 인증 (Access Key 없이 Role ARN 사용)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-northeast-2

      # 4️⃣ Docker 이미지 빌드
      - name: Build Docker image
        working-directory: infraaudit
        run: docker build -t infraaudit-backend -f Dockerfile .

      # 5️⃣ Docker 이미지 TAR 저장
      - name: Save Docker image to tar
        run: |
          docker save infraaudit-backend -o infraaudit-backend.tar
          chmod 644 infraaudit-backend.tar

      # 6️⃣ Bastion 서버로 이미지 업로드
      - name: Copy Docker image to Bastion
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.BASTION_PUBLIC_IP }}
          username: ubuntu
          key: ${{ secrets.BASTION_SSH_KEY }}
          source: "infraaudit-backend.tar"
          target: "/home/ubuntu/"

      # 7️⃣ Bastion에서 Private EC2로 전송 및 배포
      - name: Deploy on Private EC2 via Bastion
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.BASTION_PUBLIC_IP }}
          username: ubuntu
          key: ${{ secrets.BASTION_SSH_KEY }}
          script: |
            # 1. Private EC2로 전송
            scp -i /home/ubuntu/private-cloud-doctor.pem -o StrictHostKeyChecking=no /home/ubuntu/infraaudit-backend.tar ubuntu@${{ secrets.PYTHON_PRIVATE_IP }}:/home/ubuntu/

            # 2. Private EC2에서 배포
            ssh -i /home/ubuntu/private-cloud-doctor.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.PYTHON_PRIVATE_IP }} << 'EOF'
              # OIDC로 가져온 임시 자격 증명을 컨테이너에 전달
              # (주의: step 3에서 인증했으므로 환경변수에 이미 설정되어 있음)
              sudo docker load -i /home/ubuntu/infraaudit-backend.tar
              sudo docker stop infraaudit-backend || true
              sudo docker rm infraaudit-backend || true
              sudo docker run -d -p 8000:8000 \
                -e AWS_ACCESS_KEY_ID=${{ env.AWS_ACCESS_KEY_ID }} \
                -e AWS_SECRET_ACCESS_KEY=${{ env.AWS_SECRET_ACCESS_KEY }} \
                -e AWS_SESSION_TOKEN=${{ env.AWS_SESSION_TOKEN }} \
                -e AWS_DEFAULT_REGION=ap-northeast-2 \
                --restart unless-stopped \
                --name infraaudit-backend \
                infraaudit-backend
            EOF
